function getClientIP(e){var a=e.headers["x-forwarded-for"]||e.connection.remoteAddress,r=new RegExp(":");return r.test(a)?(a=a.split(":"),a[a.length-1]):a}function load_cookie(e,a,r){globalVariable.event.emit("cookiesLoaded",new Cookies(e,a),e.user_id,r),globalVariable.event.on("cookiesLoaded",cookiesLoadedCallback)}function cookiesLoadedCallback(e,a,r){globalVariable.event.removeListener("cookiesLoaded",cookiesLoadedCallback),globalVariable[a].cookies=e,r()}var http=require("http"),EventEmitter=require("events").EventEmitter,express=require("express"),fileUpload=require("express-fileupload"),url=require("url"),session=require("express-session"),bodyParser=require("body-parser"),Cookies=require("cookies"),User=require("pratos_user_class"),fs=require("fs"),globalVariable=[],app=express(),plugins=require("pratos_plugin_class"),uuidV1=require("uuid/v1");globalVariable.event=new EventEmitter,cmd=require("node-cmd"),proxyPort=3e3,webserverPort=3003,app.use(bodyParser.json()).use(fileUpload()).use(bodyParser.urlencoded({extended:!0})).use(session({secret:"s",saveUninitialized:!1,resave:!1})).use(function(e,a,r){var i=uuidV1();globalVariable[i]=Object(),e.user_id=i,globalVariable[i].request=e,load_cookie(e,a,function(){r()})}),plugins.list(globalVariable,app,function(e){globalVariable=e,plugins.webPages(app,globalVariable)}),app.get("/",function(e,a){User.verify_connection(e.user_id,globalVariable,function(r){1!=r?(a.setHeader("Content-Type","text/html"),a.render(__dirname+"/views/index.ejs"),delete globalVariable[e.user_id]):(a.redirect("/admin/index/"),delete globalVariable[e.user_id])})}),app.post("/user_connect/",function(e,a){e.body.password&&User.connect_user(e.user_id,globalVariable,function(r){1==r?(a.redirect("/admin/index/"),delete globalVariable[e.user_id]):(a.redirect("/"),delete globalVariable[e.user_id])})}),app.get("/user_disconnect/",function(e,a){globalVariable.event.emit("user","disconnected"),e.session.destroy(),a.clearCookie("device_allowed"),a.redirect("/"),delete globalVariable[e.user_id]}),app.get("/admin/:adminURI/",function(e,a){User.verify_connection(e.user_id,globalVariable,function(r){1==r?require("pratos_navbar_class").construct(globalVariable.navbarPlugins,function(r){a.setHeader("Content-Type","text/html"),"index"==e.params.adminURI?require("pratos_homepage_class").construct(globalVariable.homepagePlugins,function(i){a.render(__dirname+"/views/admin_"+e.params.adminURI+".ejs",{nav:r,content:globalVariable.contentPlugins,homepage:i})}):"settings"==e.params.adminURI?require("pratos_homepage_class").construct(globalVariable.homepagePlugins,function(i){a.render(__dirname+"/views/admin_"+e.params.adminURI+".ejs",{nav:r,content:globalVariable.contentPlugins,settings:globalVariable.pluginsSettings})}):a.render(__dirname+"/views/admin_"+e.params.adminURI+".ejs",{nav:r,content:globalVariable.contentPlugins}),delete globalVariable[e.user_id]}):(a.redirect("/"),delete globalVariable[e.user_id])})}),app.get("/list_accessories/",function(e,a){User.verify_connection(e.user_id,globalVariable,function(r){function i(r,n){"list:obtained"==r&&(globalVariable.event.removeListener("accessories",i),a.end(n),delete globalVariable[e.user_id])}if(1==r){a.setHeader("Content-Type","application/json");var n=require("pratos_accessories_class");n.list_accessories(globalVariable),globalVariable.event.on("accessories",i)}else a.redirect("/"),delete globalVariable[e.user_id]})}),app.get("/accessories_icon/",function(e,a){a.setHeader("Content-Type","application/json"),fs.readFile(__dirname+"/conf/auto_accessories_icon.json","utf8",function(e,r){a.end(r)})}),app.get("/change_state/",function(e,a){User.verify_connection(e.user_id,globalVariable,function(r){if(1==r){a.setHeader("Content-Type","application/json");var i=require("pratos_accessories_class");i.change_state(e.user_id,globalVariable,function(r){a.end(r),delete globalVariable[e.user_id]})}else a.redirect("/"),delete globalVariable[e.user_id]})}),app.post("/update_accessory/",function(e,a){User.verify_connection(e.user_id,globalVariable,function(r){if(1==r){a.setHeader("Content-Type","application/json");var i=require("pratos_accessories_class");i.update_accessory(e.user_id,globalVariable,function(r){a.end("true"),delete globalVariable[e.user_id]})}else a.redirect("/"),delete globalVariable[e.user_id]})}),app.get("/add_allowed_device/",function(e,a){User.verify_connection(e.user_id,globalVariable,function(r){1==r?User.add_allowed_device(e.user_id,globalVariable,function(r){a.redirect("/"),delete globalVariable[e.user_id]}):(a.redirect("/"),delete globalVariable[e.user_id])})}),app.get("/remove_allowed_device/",function(e,a){globalVariable.event.emit("user","remove_device"),a.clearCookie("device_allowed"),a.redirect("/"),delete globalVariable[e.user_id]}),app.get("/css/:file.ejs",function(e,a){globalVariable.session=e.session,a.setHeader("Content-Type","text/css"),a.render(__dirname+"/views/css/"+e.params.file+".ejs",{variable:globalVariable}),delete globalVariable[e.user_id]}),app.post("/register_new_icon/",function(e,a){const r=require("uuid/v1");var i=r().replace(/0/g,"").replace(/1/g,"");User.verify_connection(e.user_id,globalVariable,function(r){if(1==r)if(globalVariable.event.emit("accessories","uploading_images"),e.files.file1&&e.files.file2){var n=require("sharp"),o=i+"1.png",t=i+"0.png";n(e.files.file1.data).resize(32,32).crop(n.strategy.centre).toFormat("png").toBuffer().then(function(e){fs.writeFile(__dirname+"/static/img/icons/"+o,e)}),n(e.files.file2.data).resize(32,32).crop(n.strategy.centre).toFormat("png").toBuffer().then(function(e){fs.writeFile(__dirname+"/static/img/icons/"+t,e)}),fs.readFile(__dirname+"/conf/auto_accessories_icon.json","utf8",function(r,i){var n=JSON.parse(i);n[e.body.type][o]="/"+o,n[e.body.type][t]="/"+t,fs.writeFile(__dirname+"/conf/auto_accessories_icon.json",JSON.stringify(n)),a.setHeader("Content-Type","application/json"),globalVariable.event.emit("accessories","uploading_images:successed"),a.end('{"icon_on":"'+o+'", "icon_off":"'+t+'"}'),delete globalVariable[e.user_id]})}else a.end("err"),delete globalVariable[e.user_id];else a.end("err"),delete globalVariable[e.user_id]})}),app.get("/get_banned_ip/",function(e,a){User.verify_connection(e.user_id,globalVariable,function(r){1==r?(a.setHeader("Content-Type","application/json"),fs.readFile(__dirname+"/conf/auto_ip_ban.json","utf8",function(r,i){globalVariable.event.emit("ban","listing");var i=JSON.parse(i);a.end(JSON.stringify(i.banned_ip)),delete globalVariable[e.user_id]})):(a.redirect("/"),delete globalVariable[e.user_id])})}),app.post("/ban_ip/",function(e,a){User.verify_connection(e.user_id,globalVariable,function(r){if(1==r){a.setHeader("Content-Type","text/html"),globalVariable.event.emit("user_admin","ban:adding_banned");var i=require("pratos_ban_class");i.ban_user("Banned by admin",e.body.ip,function(r){globalVariable.event.emit("user_admin","ban:added_banned"),a.end("true"),delete globalVariable[e.user_id]})}else a.redirect("/"),delete globalVariable[e.user_id]})}),app.post("/unban_ip/",function(e,a){User.verify_connection(e.user_id,globalVariable,function(r){if(1==r){a.setHeader("Content-Type","text/html"),globalVariable.event.emit("user_admin","ban:removing_banned");var i=require("pratos_ban_class");i.unban_user(e.body.ip,function(r){globalVariable.event.emit("user_admin","ban:removed_banned"),a.end("true"),delete globalVariable[e.user_id]})}else a.redirect("/"),delete globalVariable[e.user_id]})}),app.get("/reboot/",function(e,a){globalVariable.event.emit("system","reboot"),a.setHeader("Content-Type","text/html"),a.end("rebooting"),cmd.get("sudo /etc/init.d/pratos restart",function(e,a){console.log(e),console.log(a)})});var AccessoriesHomebridge=require("pratos_accessories_class"),intervalHomebridge=setInterval(function(){AccessoriesHomebridge.has_change_happened(globalVariable)},3e3);app.use(express["static"](__dirname+"/static")),cmd.get("sudo kill $(sudo lsof -t -i:"+webserverPort+")",function(){app.listen(webserverPort)}),fs.readFile(__dirname+"/conf/settings.json","utf8",function(e,a){var r=JSON.parse(a),i=require("http-proxy"),n=i.createProxyServer({});cmd.get("sudo kill $(sudo lsof -t -i:"+proxyPort+")",function(){http.createServer(function(e,a){globalVariable.event.emit("http","Request Received",e),e.headers.host=e.headers.host?e.headers.host:"";var i=e.headers.host.match(":")?e.headers.host.split(":")[0]:e.headers.host;url.parse(e.url).pathname;e.headers["x-forwarded-for"]=getClientIP(e),void 0!=e.headers["x-forwarded-for"]&&(r.DNS[i]?n.web(e,a,{target:r.DNS[i],xforward:!0,changeOrigin:!1},function(e){a.end("Serveur Indisponible")}):n.web(e,a,{target:"http://localhost:"+webserverPort,xforward:!0,changeOrigin:!1}))}).listen(proxyPort,function(){console.log("Pratos : proxyserver listening on port :"+proxyPort)})}),console.log("Pratos : webserver listening on port :"+webserverPort)});