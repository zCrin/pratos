/*
* License MIT
* « Copyright © 2018, Pratos »
* v 1.3.0
* !!! In this update Homebridge accessories are no longer designated by their AID but by their name. Changing accessory name in Homebridge config.json might lose your datas.
*/
var fs = require('fs');
const path = __dirname.replace('/node_modules/pratos_accessories_class/lib', '');
var cmd=require('node-cmd');
var list_accessories = require("../lib/accessories-list.js");
module.exports=change_stateByName;
function change_stateByName(name,value,globalVariable, callback){
		

			fs.readFile(path + "/conf/settings.json", 'utf8', function(err, data){
				var homebridge = JSON.parse(data).homebridge;
				list_accessories(globalVariable, function(dataV){
					dataV = JSON.parse(dataV);
				
					var aid =  String(dataV.accessories[0]['aid']);
					var iid = dataV.accessories[0]['iid'];
					
				var command = 'curl -X PUT '+ homebridge.host +':'+ homebridge.port + '/characteristics --header "Content-Type:Application/json" --header "authorization:'+ homebridge.pin +'" --data "{\\\"characteristics\\\":[{\\\"aid\\\":' + aid + ',\\\"iid\\\":'+iid + ',\\\"value\\\":'+ value +'}]}"';
			
				globalVariable.event.emit("accessories", "state:changing",{aid, iid,value});
				cmd.get(command, function(answer){
					globalVariable.event.emit("accessories", "state:changed",JSON.stringify(answer));
					return callback(answer);
				});
				},name);
			});
		}