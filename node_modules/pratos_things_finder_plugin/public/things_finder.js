var loadedSlickThingsFinder = 0;
function show_dataThingsFinder(data) {

    if (corres) {
        if (corres.length == 1) {
            $('#Things_Finder_plugin > .content').prepend(data);
        } else {
            if (!loadedSlickThingsFinder) {
                setTimeout(function () {
                    $('#slick-slide0' + corres['Things_Finder'] + ' > .content').prepend(data);
                    loadedSlickThingsFinder = 1;
                }, 3000);
            } else {
                $('#slick-slide0' + corres['Things_Finder'] + ' > .content').prepend(data);
            }
        }
    } else {
        $('#Things_Finder_plugin > .content').prepend(data);
    }
}


var big = 0, small = 0, pratosRegex = /pratos/gi, pratosSwitchUSREGEX = /Pratos-Switch-US/gi, pratosLightControllerREGEX = /Pratos-Light-Controller/gi, color = ["off", "on"], inLocal = JSON.parse(localStorage.getItem("objects"));
inLocal && Array.isArray(inLocal) || (inLocal = []);
for (var knownOne = inLocal.length, e = 0; e < knownOne; e++) {
    var localG = inLocal[e];
    $.get({
        url: "http://192.168." + localG + "/pratos-auto-config",
        timeout: 1500
    }, function (t) {
        if (pratosRegex.test(t)) {
            var a = stateFile = switchFile = "",
            i = 0;
            pratosSwitchUSREGEX.test(t) ? (a = "Pratos Smart Switch US", stateFile = "state", switchFile = "switch", i = 1) : pratosLightControllerREGEX.test(t) ? (a = "Pratos Light Controller " + t.split("-")[3], stateFile = "stateLamp", switchFile = "switchLamp", i = 0) : (stateFile = "state", a = t.replace(/-/g, ' '), switchFile = "switch", i = 0),
            $.get({
                url: "http://192.168." + localG + "/" + stateFile,
                timeout: 1e3
            }, function (t) {
		
                var e = (t - i) * (t - i);
               show_dataThingsFinder("<div ip='192.168." + localG + "'class='object_block'><div class='infos'><div><div class='type'>" + a + "</div><div class='more-infoq' onclick='show_more(\"192.168." + localG + "\")' >more <i class='fa fa-caret-down'></i></div></div><span id='state' onclick='changeItState(\"192.168." + localG + '","' + switchFile + '",' + i + ")' class='" + color[e] + "'></span></div><div class='more-infos_block'><div class='ip'>IP : 192.168." + localG + "</div> <div class='find-state'>You can find its state at <a href='http://192.168." + localG + "/" + stateFile + "'>http://192.168." + localG + "/" + stateFile + "</a></div><div class='change-state'>You can change its state at <a href='http://192.168." + localG + "/" + switchFile + "'>http://192.168." + localG + "/" + switchFile + "</a></div></div></div>")
            })
        }
    })
}
function changeItState(t, a, i) {
    $.get({
        url: "http://" + t + "/" + a,
        timeout: 500
    }, function (a) {
        var e = (a - i) * (a - i),
        s = (e - 1) * (e - 1);
        $('.object_block[ip="' + t + '"] #state').removeClass(color[s]),
        $('.object_block[ip="' + t + '"] #state').addClass(color[e])
    })
}
$("#startScan").click(function () {
    $("#startScan").hide(0),
    $("#scanBlock").fadeIn(500),
    
    scan()
});
var arrayState = [];
function show_more(t) {
    arrayState[t] ? ($('.object_block[ip="' + t + '"] .more-infos_block').hide(), $('.object_block[ip="' + t + '"] .more-infoq').html("more <i class='fa fa-caret-down'></i>"), arrayState[t] = 0) : ($('.object_block[ip="' + t + '"] .more-infos_block').show(), $('.object_block[ip="' + t + '"] .more-infoq').html("less <i class='fa fa-caret-up'></i>"), arrayState[t] = 1)
}
function scan() {
    $.get({
        url: "http://192.168." + big + "." + small + "/pratos-auto-config",
        timeout: 500
    }, function (t) {
        if (pratosRegex.test(t)) {
            var a = stateFile = switchFile = "";
            pratosSwitchUSREGEX.test(t) ? (a = "Pratos Smart Switch US", stateFile = "state", switchFile = "switch", stateCal = 1) : pratosLightControllerREGEX.test(t) ? (a = "Pratos Light Controller " + t.split("-")[3], stateFile = "stateLamp", switchFile = "switchLamp", stateCal = 0) : (stateFile = "state", a = t.replace(/-/g, ' '), switchFile = "switch", stateCal = 0),
            $.get({
                url: "http://192.168." + big + "." + small + "/" + stateFile,
                timeout: 500
            }, function (t) {
                var i = (t - stateCal) * (t - stateCal);
               show_dataThingsFinder("<div ip='192.168." + big + "." + small + "'class='object_block'><div class='infos'><div><div class='type'>" + a + "</div><div class='more-infoq' onclick='show_more(\"192.168." + big + "." + small + "\")' >more <i class='fa fa-caret-down'></i></div></div><span id='state' onclick='changeItState(\"192.168." + big + "." + small + '","' + switchFile + '",' + stateCal + ")' class='" + color[i] + "'></span></div><div class='more-infos_block'><div class='ip'>IP : 192.168." + big + "." + small + "</div> <div class='find-state'>You can find its state at <a href='http://192.168." + big + "." + small + "/" + stateFile + "'>http://192.168." + big + "." + small + "/" + stateFile + "</a></div><div class='change-state'>You can change its state at <a href='http://192.168." + big + "." + small + "/" + switchFile + "'>http://192.168." + big + "." + small + "/" + switchFile + "</a></div></div></div>"),
                inLocal.indexOf(big + "." + small) < 0 && (inLocal.push(big + "." + small), localStorage.setItem("objects", JSON.stringify(inLocal))),
                nextScan()
            }).fail(function () {
                nextScan()
            })
        } else
            nextScan()
    }).fail(function () {
        nextScan()
    })
}
function nextScan() {
    256 == ++small && (big++, small = 0),
    big < 2 ? scan() : ("")
}
scan();