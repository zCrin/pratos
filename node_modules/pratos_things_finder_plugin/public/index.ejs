
<!DOCTYPE html>
<html>
	<head>
		
		<%- include(path + "/views/includes/head-content.include.ejs") %>
		<%- include(path + "/views/includes/icons.include.ejs") %>
		<%- include(path + "/views/includes/css.include.ejs") %>
		<script src="/js/jquery.min.3-1-0.js"></script>
		<script src="/js/stay_standalone.js"></script>
		<link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css"/>
		<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
		<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
	</head>
	<body>
		<%- include(path + "/views/includes/header.include.ejs") %>
		<%- include(path+  "/views/includes/navbar.include.ejs", {nav : nav})%>
		<div class='page page-nav'><article></article><button id='startScan'>Scan</button>
		<div id="scanBlock">
		<h2>Scanning</h2><div class="loader"></div>
		<p>This operation might take more than 5 minutes. <br/>Please make sure you are connected over the same Wifi network as your Pratos Smart Thing.<br/>Next time should be faster.</p></div>
		</div></body>
			<script src='/js/navbar_auto.js'></script>
<script>var big = 0, small = 0, pratosRegex = /pratos/gi, pratosSwitchUSREGEX = /Pratos-Switch-US/gi, pratosLightControllerREGEX = /Pratos-Light-Controller/gi, color = ["off", "on"], inLocal = JSON.parse(localStorage.getItem("objects"));
inLocal && Array.isArray(inLocal) || (inLocal = []);
for (var knownOne = inLocal.length, e = 0; e < knownOne; e++) {
    var localG = inLocal[e];
    $.get({
        url: "http://192.168." + localG + "/pratos-auto-config",
        timeout: 1500
    }, function (t) {
        if (pratosRegex.test(t)) {
            var a = stateFile = switchFile = "",
            i = 0;
            pratosSwitchUSREGEX.test(t) ? (a = "Pratos Smart Switch US", stateFile = "state", switchFile = "switch", i = 1) : pratosLightControllerREGEX.test(t) ? (a = "Pratos Light Controller " + t.split("-")[3], stateFile = "stateLamp", switchFile = "switchLamp", i = 0) : (stateFile = "state", a = t.replace(/-/g, ' '), switchFile = "switch", i = 0),
            $.get({
                url: "http://192.168." + localG + "/" + stateFile,
                timeout: 1e3
            }, function (t) {
		
                var e = (t - i) * (t - i);
                $("article").prepend("<div ip='192.168." + localG + "'class='object_block'><div class='infos'><div><div class='type'>" + a + "</div><div class='more-infoq' onclick='show_more(\"192.168." + localG + "\")' >more <i class='fa fa-caret-down'></i></div></div><span id='state' onclick='changeItState(\"192.168." + localG + '","' + switchFile + '",' + i + ")' class='" + color[e] + "'></span></div><div class='more-infos_block'><div class='ip'>IP : 192.168." + localG + "</div> <div class='find-state'>You can find its state at <a href='http://192.168." + localG + "/" + stateFile + "'>http://192.168." + localG + "/" + stateFile + "</a></div><div class='change-state'>You can change its state at <a href='http://192.168." + localG + "/" + switchFile + "'>http://192.168." + localG + "/" + switchFile + "</a></div></div></div>")
            })
        }
    })
}
function changeItState(t, a, i) {
    $.get({
        url: "http://" + t + "/" + a,
        timeout: 500
    }, function (a) {
        var e = (a - i) * (a - i),
        s = (e - 1) * (e - 1);
        $('.object_block[ip="' + t + '"] #state').removeClass(color[s]),
        $('.object_block[ip="' + t + '"] #state').addClass(color[e])
    })
}
$("#startScan").click(function () {
    $("#startScan").hide(0),
    $("#scanBlock").fadeIn(500),
    
    scan()
});
var arrayState = [];
function show_more(t) {
    arrayState[t] ? ($('.object_block[ip="' + t + '"] .more-infos_block').hide(), $('.object_block[ip="' + t + '"] .more-infoq').html("more <i class='fa fa-caret-down'></i>"), arrayState[t] = 0) : ($('.object_block[ip="' + t + '"] .more-infos_block').show(), $('.object_block[ip="' + t + '"] .more-infoq').html("less <i class='fa fa-caret-up'></i>"), arrayState[t] = 1)
}
function scan() {
    $.get({
        url: "http://192.168." + big + "." + small + "/pratos-auto-config",
        timeout: 500
    }, function (t) {
        if (pratosRegex.test(t)) {
            var a = stateFile = switchFile = "";
            pratosSwitchUSREGEX.test(t) ? (a = "Pratos Smart Switch US", stateFile = "state", switchFile = "switch", stateCal = 1) : pratosLightControllerREGEX.test(t) ? (a = "Pratos Light Controller " + t.split("-")[3], stateFile = "stateLamp", switchFile = "switchLamp", stateCal = 0) : (stateFile = "state", a = t.replace(/-/g, ' '), switchFile = "switch", stateCal = 0),
            $.get({
                url: "http://192.168." + big + "." + small + "/" + stateFile,
                timeout: 500
            }, function (t) {
                var i = (t - stateCal) * (t - stateCal);
                $("article").prepend("<div ip='192.168." + big + "." + small + "'class='object_block'><div class='infos'><div><div class='type'>" + a + "</div><div class='more-infoq' onclick='show_more(\"192.168." + big + "." + small + "\")' >more <i class='fa fa-caret-down'></i></div></div><span id='state' onclick='changeItState(\"192.168." + big + "." + small + '","' + switchFile + '",' + stateCal + ")' class='" + color[i] + "'></span></div><div class='more-infos_block'><div class='ip'>IP : 192.168." + big + "." + small + "</div> <div class='find-state'>You can find its state at <a href='http://192.168." + big + "." + small + "/" + stateFile + "'>http://192.168." + big + "." + small + "/" + stateFile + "</a></div><div class='change-state'>You can change its state at <a href='http://192.168." + big + "." + small + "/" + switchFile + "'>http://192.168." + big + "." + small + "/" + switchFile + "</a></div></div></div>"),
                inLocal.indexOf(big + "." + small) < 0 && (inLocal.push(big + "." + small), localStorage.setItem("objects", JSON.stringify(inLocal))),
                nextScan()
            }).fail(function () {
                nextScan()
            })
        } else
            nextScan()
    }).fail(function () {
        nextScan()
    })
}
function nextScan() {
    256 == ++small && (big++, small = 0),
    big < 2 ? scan() : ($("#startScan").fadeIn(500),  $("#scanBlock").fadeOut(500))
}
</script><style>

#startScan{
    background-color: white;
	cursor:pointer;
    color: <%= global_color %>;
	border:1px solid <%= global_color %>;
    display: table;
    padding: 1%;
    border-radius: 50px;
    text-align: center;
    margin: 1% auto;
    font-size: 150%;
	box-shadow:0.2px 0.2px 10px 0px <%= global_color %>;
}
p{
    color: lightgrey;
     font-weight: 200;
     font-size: 110%;
    line-height:30px;
    text-align:center;
	
}
.loader{
    border: 4px solid #f3f3f3;
    /* Light grey */
     border-top: 4px solid <%= global_color %>;
    /* Blue */
     border-radius: 50%;
     width: 50px;
     height: 50px;
     animation: spin 1.5s linear infinite;
    margin:4% auto;
    
}
h2{
    margin: 4% auto;
     font-family: Arial;
     font-weight: 200;
     font-size: 200%;
  
    color:<%= global_color %>;
    text-align:center;
}
#state{
    width: 40px;
     height: 40px;
     display: block;
     cursor: pointer;
     border-radius: 50%;
}
@keyframes spin{
    0%{
        transform: rotate(0deg);
    }
    100%{
        transform: rotate(360deg);
    }
}
.object_block{
    background-color:white;
    border-bottom: lightgrey 1px solid;
     padding: 2%;
     color: rosybrown;
     font-size: 120%;
    width: 90%;
     margin: 2% auto;
     box-shadow: 0.2px 0.2px 10px 0px <%= global_color %>;
}
.type{
    font-size:130%;
}
.more-infoq{
    color: <%= global_color %>;
     font-size: 90%;
     margin: 2%;
    cursor: pointer;
}
.object_block .infos{
    display: flex;
     align-items: center;
     vertical-align: middle;
     justify-content: space-between;
     width: 80%;
     margin: 1% auto;
}
.more-infos_block{
    padding: 0 0 0 15%;
     color: <%= background_color %>;
     font-size: 90%;
}
.more-infos_block div{
    margin-top:2%;
}
.off{
    background-color: indianred;
}
.on{
    background-color: lightgreen;
}
.page-nav{
height:0%;}
#scanBlock{
display:none;
border-radius: 50px;
	  background-color: white;
	   padding: 1%;
	   width:90%;
	   margin: 2% auto;
}
.more-infos_block{
    display:none;
}
 </style>
 	<% 
var contentNames = Object.keys(content);
var contentL = contentNames.length;

		var loaded ={};
		for(var u = 0; u < contentL; u++){ 
var y = new RegExp(content[contentNames[u]].page,'g');
			if(page_name.match(y) && !loaded[content[contentNames[u]].script]){
loaded[content[contentNames[u]].script] == 1;%>
	<%- content[contentNames[u]].script%>
	<%	}}
	%>
</html>
