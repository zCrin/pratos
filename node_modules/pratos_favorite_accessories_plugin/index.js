const path = __dirname.replace('/node_modules/pratos_favorite_accessories_plugin', '');
var fs = require('fs');
var Cookies = require("cookies");

var user = require(path+'/lib/users.js');
module.exports = {
	config:function(){
		var conf = Object();
		conf.GET = true;
		conf.on_content = true;
		conf.on_homepage = true;
conf.SOCKET=true;
		return conf;
	},
socket:function(client, globalVariable){},
	get:function(app, globalVariable){
		app.get('/favorite_accessory.js', function(req, res) {
			res.setHeader('Content-Type', 'application/javascript');
			fs.readFile( __dirname + '/favorite_accessory.js', 'utf8', function(err, data){
			res.end(data);
});
		});
		app.get('/favorite_accessory.list', function(req, res) {
			  user.is_connected(req.user_id, function (response,user_res) {
			if (response == true) {
			res.setHeader('Content-Type', 'application/json');
			fs.readFile( __dirname + '/favorite_accessory.list', 'utf8', function(err, data){
			res.end(data);
			
});
}else{
				res.end('error')
			}
		});
		});
		app.get('/toggle_favorite/', function(req, res) {
			  user.is_connected(req.user_id, function (response,user_res) {
			if (response == true) {
					if(globalVariable[req.user_id].request.query.aid){
aid = globalVariable[req.user_id].request.query.aid;
						fs.readFile( __dirname + '/favorite_accessory.list', 'utf8', function(err, data){
							var file = JSON.parse(data);
							var dataL = file.favorite_accessories.length;
							if(file.favorite_accessories.indexOf(aid) > -1){
								file.favorite_accessories.splice(file.favorite_accessories.indexOf(aid), 1);
							}
							else{
								file.favorite_accessories.push(aid);
							}
fs.writeFile( __dirname + '/favorite_accessory.list', JSON.stringify(file));
						res.redirect('/favorite_accessory.list');
						});
					}
					else{
						res.end("No aid provided");
					}
				}
				else{
					res.end("Not connected");
				}
			});
		});
	},
	content:function(link){
		link["favorite_accessory_plugin1"]={"page":"/home|/manage_accessories","script":"<script src='/favorite_accessory.js'></script>"};
link["favorite_accessory_plugin2"]={"page":"/home","script":" <script src='/socket.io/socket.io.js'></script>"};

		return link;
	},
	homepage:function(homepage){
		homepage.createBox("Accessoires Favoris", "<p style='padding: 3%; text-align: center;'>Loading favorites accessories... <br /> Please wait ...</p>", true);
	}
};