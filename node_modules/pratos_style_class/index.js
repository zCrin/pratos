var Jimp = require("jimp"); 
const path = __dirname.replace('/node_modules/pratos_style_class', '');
const fs = require('fs');
const pngToIco = require('png-to-ico');
var colors = 0;
module.exports = {
get_global_color:function(callback){
if(!colors){
fs.readFile(__dirname+"/colors.txt", 'utf8', function(err, data){
colors = JSON.parse(data);

return callback(colors.global_color.r, colors.global_color.g, colors.global_color.b, colors.global_color.a);
});
}
else{

return callback(colors.global_color.r, colors.global_color.g, colors.global_color.b, colors.global_color.a);
}
},
get_background_color:function(callback){
if(!colors){
fs.readFile(__dirname+"/colors.txt", 'utf8', function(err, data){
colors = JSON.parse(data);
return callback(colors.background_color.r, colors.background_color.g, colors.background_color.b, colors.background_color.a);
});
}
else{

return callback(colors.background_color.r, colors.background_color.g, colors.background_color.b, colors.background_color.a);
}
},
set_global_colors:function(r,g,b,a,callback){
if(!colors){
fs.readFile(__dirname+"/colors.txt", 'utf8', function(err, data){
colors = JSON.parse(data);
colors.global_color ={r:r,g:g,b:b,a:a};
fs.writeFile(__dirname+"/colors.txt", JSON.stringify(colors),function(){
return callback(true);
});
});
}
else{
colors.global_color ={r:r,g:g,b:b,a:a};
fs.writeFile(__dirname+"/colors.txt", JSON.stringify(colors),function(){
return callback(true);
});
}
},
set_background_colors:function(r,g,b,a,callback){
if(!colors){
fs.readFile(__dirname+"/colors.txt", 'utf8', function(err, data){
colors = JSON.parse(data);
colors.background_color ={r:r,g:g,b:b,a:a};
fs.writeFile(__dirname+"/colors.txt", JSON.stringify(colors), function(){
return callback(true);
});
});
}
else{
colors.background_color ={r:r,g:g,b:b,a:a};
fs.writeFile(__dirname+"/colors.txt", JSON.stringify(colors), function(){
return callback(true);
});
}
},
change_colorsApi:function(user_id, globalVariable,callback){

var y = new RegExp("^rgb\\(([1-9]+), ([1-9]+), ([1-9]+)\\)$");
if(y.test(globalVariable[user_id].request.query. globalColor)){
this.set_global_colors(parseInt(RegExp.$1), parseInt(RegExp.$2), parseInt (RegExp.$3),255,function(){
module.exports. change_logo_color(parseInt(RegExp.$1), parseInt(RegExp.$2), parseInt (RegExp.$3),255,function(){
var u = new RegExp("^rgb\\(([1-9]+), ([1-9]+), ([1-9]+)\\)$");
if(u.test(globalVariable[user_id].request.query. bck)){
module.exports. set_background_colors(parseInt(RegExp.$1), parseInt(RegExp.$2), parseInt (RegExp.$3),255,function(){
return callback("done");
});
}
});
});
}



},
change_logo_color:function(r, g, b, a,callback){

var arrayFiles ={
'/static/img/website-icons/android-chrome-192x192.png':{width:192,height:192},
'/static/img/website-icons/apple-touch-icon-114x114.png':{width:114,height:114},
'/static/img/website-icons/apple-touch-icon-120x120.png':{width:120,height:120},
'/static/img/website-icons/apple-touch-icon-144x144.png' :{width:144,height:144},
'/static/img/website-icons/apple-touch-icon-152x152.png' :{width:152,height:152},
'/static/img/website-icons/apple-touch-icon-180x180.png' :{width:180,height:180},
'/static/img/website-icons/apple-touch-icon-57x57.png' :{width:57,height:57},
'/static/img/website-icons/apple-touch-icon-60x60.png' :{width:60,height:60},
'/static/img/website-icons/apple-touch-icon-72x72.png' :{width:72,height:72},
'/static/img/website-icons/apple-touch-icon-76x76.png' :{width:75,height:76},
'/static/img/website-icons/favicon-16x16.png' :{width:16,height:16},
'/static/img/website-icons/favicon-32x32.png' :{width:32,height:32},
'/static/img/website-icons/favicon-96x96.png' :{width:96,height:96},
'/static/img/website-icons/favicon.png' :{width:32,height:32},
'/static/img/website-icons/largetile.png' :{width:310,height:310},
'/static/img/website-icons/mediumtile.png' :{width:150,height:150},
'/static/img/website-icons/smalltile.png' :{width:70,height:70},
'/static/img/website-icons/widetile.png' :{width:310,height:150}
};
 
// open a file called "lenna.png" 
change_color(path+"/static/img/logo2.png", path+"/static/img/logo.png", Jimp.rgbaToInt(r, g, b, a),arrayFiles,callback);
}

};
function change_color(pathTo,pathNew,color,saveList,callback){
Jimp.read(pathTo, function (err, image) {

    if (err) throw err;

var imW = image.bitmap.width,
imH = image.bitmap.height,
imgTransparent = image.clone();

for(var x=0;x<imW;x++){
for(var y=0;y<imH;y++){
var c = image.getPixelColor(x, y);
if(c && c[0]+""+c[1] !='42'){
imgTransparent. setPixelColor(color, x, y); 
    image.setPixelColor(color, x, y);  

}else{
image.setPixelColor(Jimp.rgbaToInt(255, 255, 255, 255), x, y);  
}

}
}
image.rgba( true );             // set whether PNGs are saved as RGBA (true, default) or RGB (false) 
image.filterType( -1 );     // set the filter type for the saved PNG 
image.deflateLevel( 0 );  
filesName = Object.keys(saveList),
			filesNameLength = filesName.length;
for(var r=0;r<filesNameLength;r++){
	var t = image.clone();    
t.resize(saveList[filesName[r]].width, saveList[filesName[r]].height);

if(filesName[r] =='/static/img/website-icons/favicon.png'){
var ui= path+filesName[r];
t.write(path+filesName[r], function(){

pngToIco(ui).then(buf => {
    fs.writeFileSync(ui.replace('png','ico'), buf);
  })
  .catch(console.error);
});
}
 else{
t.write(path+filesName[r]);
}


}
imgTransparent.write(pathNew);
return callback(true);
});
}

