
<!DOCTYPE html>
<html>
	<head>
		<% include includes/head-content.include.ejs %>
		<%	include includes/icons.include.ejs %>
		<%	include includes/css.include.ejs %>

		<script src="/js/jquery-1.11.3.min.js"></script>
		<script src="/js/stay_standalone.js"></script>
		<link rel="stylesheet" type="text/css" href="//maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css"/>
		<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
		<link rel="stylesheet" type="text/css"href="/css/bootstrap-colorpicker.min.css">

		<script src="//code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
	</head>
	<body>

		<% include includes/header.include.ejs %>
		<%- include("includes/navbar.include.ejs", {nav : nav})%>
		<div  id='settings_page'  class='page page-nav'>

<div id="settings-step-back"> <i class='fa fa-chevron-left'></i>  Retour</div>
<div id='settings_main_menu'>
			<h2>Réglages</h2>
<div id='pluginsButton' class='settings_menu_button'>
<i class='fa fa-plug'></i><span>Plugins</span> </div>
<div id='styleButton' class='settings_menu_button'>
<i class='fa fa-pencil'></i><span>Style</span></div>
<div id='conditionsButton' class='settings_menu_button'>
<i class='fa fa-codepen'></i><span>Recettes</span></div>

<% 
		var settingsN = Object.keys(settings);
	var settingsL = settingsN.length;
for(var i = 0; i < settingsL; i++){ %>
	<%- "<div id='"+ settings [settingsN[i]]. buttonName +"'class='settings_menu_button'>"+ settings [settingsN[i]]. buttonIcon +"<span>"+ settings [settingsN[i]].title+"</span></div> "%>
	<%	}
	%>
</div>
<div class='settings_page settings_menu' id='styleBox'>
<h2>Style</h2>
<div id='flexStyle'>
<div>
<h3>Couleur primaire</h3>
<div id="cp8_container">

</div>
</div><div>
<h3>Couleur de l’arrière-plan</h3>
<div id="cp9_container">

</div>
</div>
</div>
<button id='resetColors'>Original</button>
<button id='saveColors'>Sauvegarder</button>
</div>

<div class='settings_page settings_menu' id='conditionsBox'>
<h2>Recettes</h2>
<p>Ici vous pouvez créer/modifier une nouvelle recette, des actions lancées à partir d'évênements, conditions.</p>
<button id='createNewRecipe'>Créer une nouvelle recette</button>
<div id="blocklyDiv"></div>
<xml id="toolbox" style="display: none">
  <block type="controls_if"></block>
  <block type="controls_repeat_ext"></block>
  <block type="logic_compare"></block>
  <block type="math_number"></block>
  <block type="math_arithmetic"></block>
  <block type="text"></block>
  <block type="text_print"></block>
</xml>
</div>


<div class='settings_page settings_menu' id='pluginsBox'>
<h2>Plugins</h2>

<div id='deletePluginsButton' class='settings_menu_button'>
<i class='fa fa-trash'></i><span>Supprimer</span> </div>

<div id='turnPluginsButton' class='settings_menu_button'>
<i class='fa fa-eye-slash'></i><span>Gérer</span> </div>
</div>

<div class='settings_page settings_pagebox  settings_menu' id='deletePluginsBox'>


</div>

<div class='settings_page settings_pagebox settings_menu' id='turnPluginsBox'>

</div>
<%
for(var i = 0; i < settingsL; i++){ %>
	<%- "<div class='settings_page settings_pagebox settings_menu' id='"+ settings [settingsN[i]].buttonName.replace("Button","Box")+"'>"+ settings [settingsN[i]].boxContent +"</div> "%>
	<%	}
	%>
		<div id='rebootpopup' class='popup'>
			<h2>Redémarrer</h2>
			<p>Pour appliquer les modifications, Pratos doit redémarrer. Voulez-vous redémarrer maintenant ?</p>
					<button onClick='reboot(true)'  id='validate_ban'>Oui</button>
					<button onClick='reboot(false)' id='validate_ban'>Non</button>
		</div>
		</div>

	</body>

	
	<script src='/js/navbar_auto.js'></script>
		<script src="/js/bootstrap-colorpicker.min.js"></script>
 <script src="/socket.io/socket.io.js"></script>

<script>
var show_actual;
var nbLoaded=0;
$("#conditionsButton").click(function(){

$.cachedScript( "https://cdn.jsdelivr.net/npm/blockly@1.0.0/blockly_compressed.js" ).done(function( script, textStatus ) {
  scriptLoadedBlockly();
});

$.cachedScript( "https://cdn.jsdelivr.net/npm/blockly@1.0.0/msg/js/fr.js" ).done(function( script, textStatus ) {
    scriptLoadedBlockly();
});
$.cachedScript( "https://cdn.jsdelivr.net/npm/blockly@1.0.0/blocks_compressed.js" ).done(function( script, textStatus ) {
    scriptLoadedBlockly();
});
function scriptLoadedBlockly(){
    nbLoaded++;
if(nbLoaded==3){
setTimeout(function(){
$("#createNewRecipe").fadeIn(1000);
},3000);
}
}
//<script src='https://cdn.jsdelivr.net/npm/blockly@1.0.0/blockly_uncompressed.js'>
//script><script src='https://cdn.jsdelivr.net/npm/blockly@1.0.0/msg/js/fr.js'>
//script><script src='https://cdn.jsdelivr.net/npm/blockly@1.0.0/blocks_compressed.js'>
//script>
});
jQuery.cachedScript = function( url, options ) {
 
  // Allow user to set any option except for dataType, cache, and url
  options = $.extend( options || {}, {
    dataType: "script",
    cache: true,
    url: url
  });
 
  // Use $.ajax() since it is more flexible than $.getScript
  // Return the jqXHR object so we can chain callbacks
  return jQuery.ajax( options );
};
 
// Usage

		$('.page').mousedown(function(e){ //fonction qui permet de cacher les popup lorsqu'on clique a coté
			if(! $(show_actual).is(e.target) // if the target of the click isn't the container
				&&  $(show_actual).has(e.target).length === 0){ //nor a descendant of the container
   				$('.popup').each(function(){
					$(show_actual).hide(1000);
});//on cache le popup actuel
			}
		});

$(".settings_menu_button").click(menuButton);
function menuButton(){
var toOpen = $(this).attr("id").replace("Button","Box");

$("#"+toOpen).show(500);
$(this).parent().hide(500);
$("#settings-step-back").show(100);
}


$("#settings-step-back").click(function(){
	var toClose = '#'+$('.settings_page:visible').attr("id");
	var toOpenButton = toClose.replace("Box","Button");
var toOpen = $(toOpenButton).parent();

	


	
$(toClose).hide(500);
toOpen.show(500);
if(toOpen.attr('id') == 'settings_main_menu'){
$("#settings-step-back").hide(100);
}
});
$("#turnPluginsButton").click(function(){
$.getJSON("/list_plugins/",function(data){
var old = put_in_object(data.plugins);
var pluginsName = Object.keys(data.plugins),
	dataLength = pluginsName.length;
var txt ='';
var arrayCheck = ['','checked'];
for(var i = 0; i < dataLength; i++){

txt += '<div class="downloaded_plugin"><div class="downloaded_plugin_name">'+ pluginsName[i].replace('pratos_',''). replace('_plugin','') + '</div><label class="switch"><input '+ arrayCheck[data.plugins [pluginsName[i]]] + '  type="checkbox" id="'+ pluginsName[i]+'"><span class="sliderSettings round"></span></label></div>';

}
$("#turnPluginsBox").html('<h2>Gérer</h2> '+txt);
$(".switch > input").unbind();
$(".switch > input").change(function(){
var type = 0;
$(".savedPluginsTurn").remove();
if($(this).is(":checked")){type=1;}
data.plugins[$(this).attr('id')] = type;
if(!is_same(data.plugins,old)){

$("#turnPluginsBox").append("<div class='savedPluginsTurn ' id='savedPlugins'><button>Sauvegarder</button></div>");
$('.savedPluginsTurn').show(1000);
$(".savedPluginsTurn > button").unbind();
$(".savedPluginsTurn > button").click(function(){

$.post('/toggle_plugins/', {pluginsList:data},function(response){
if(response == 'reboot_allowed'){
$('#rebootpopup').show(1000);
show_actual = '#rebootpopup';
}
else{
alert('Erreur');
}
});

});
}
else{
$('.savedPluginsTurn').hide(1000);
$(".savedPluginsTurn").remove();
}
});
});

});

$("#deletePluginsButton").click(function(){
$.getJSON("/list_plugins/",function(data){
var pluginsName = Object.keys(data.plugins),
	dataLength = pluginsName.length;
var txt ='';
var arrayCheck = ['inactive_plugin','active_plugin'];
for(var i = 0; i < dataLength; i++){

txt += '<div class="downloaded_plugin '+ arrayCheck[data.plugins [pluginsName[i]]] + '"><div class="downloaded_plugin_name">'+ pluginsName[i].replace('pratos_',''). replace('_plugin','') + '</div><input  class="delete_plugin_check" type="checkbox"></div>';

}
$("#deletePluginsBox").html('<h2>Supprimer</h2> '+ txt);
$(".delete_plugin_check").change(function(){
var has_checked = 0;
var listPlugins = Array();
$(".delete_plugin_check").each(function(){

if($(this).is(':checked')){
listPlugins.push('pratos_'  + $(this).siblings('.downloaded_plugin_name').text() + '_plugin');
has_checked = 1;
}

});
if(has_checked){
has_checked=0;
$(".savedPluginsDelete").remove();
$("#deletePluginsBox").append("<div class='savedPluginsDelete' id='savedPlugins'><button>Sauvegarder</button></div>");

$('.savedPluginsDelete').show(1000);
$(".savedPluginsDelete > button"). unbind();
$(".savedPluginsDelete > button"). click(function(){


$.post('/remove_plugins/', {pluginsList:listPlugins},function(response){
if(response == 'reboot_allowed'){
$('#rebootpopup').show(1000);
show_actual = '#rebootpopup';
}
else{
alert('Erreur');
}
});
});
}
else{
$('.savedPluginsDelete').hide(1000);
$(".savedPluginsDelete").remove();
}
});
});

});
function is_same(objOne, objTwo){
var objOneKeys = Object.keys(objOne),
	objOneLength = objOneKeys.length,
	objTwoKeys = Object.keys(objTwo),
	objTwoLength = objTwoKeys.length;

if(objOneLength==objTwoLength){
for(var i = 0; i < objOneLength; i++){

if(objOne[objOneKeys[i]] != objTwo[objTwoKeys[i]]){
return false;
}
else if(objOne[objOneKeys[i]] == objTwo[objTwoKeys[i]] && i == (objOneLength-1)){
return true;
}
}

}
else{

return false;
}
}
function put_in_object(objOne){
var objOneKeys = Object.keys(objOne),
	objOneLength = objOneKeys.length;
var n = Object();
for(var i = 0; i < objOneLength; i++){
n[objOneKeys[i]] = objOne[objOneKeys[i]];
}

return n;
}
function reboot(t){
if(!t){
		$(show_actual).hide(1000);
}
else{
$.get('/reboot/',function(data){
	if(data == 'rebooting'){
		alert('Pratos is rebooting, please wait');
		setTimeout(function(){location.reload()},5000);
}
else{
alert('Erreur');
}
});

}
}
$("#createNewRecipe").click(function(){
$("#blocklyDiv").css("width","100%");
$("#blocklyDiv").fadeIn(1000);
var workspacePlayground = Blockly.inject('blocklyDiv',{toolbox: document.getElementById('toolbox')});


$("#createNewRecipe").fadeOut(500);
});
$("#styleButton").click(function(){
var global_color = $("h2").css("color");
var background_color = $("body").css("background-color");
    $('#cp8_container').colorpicker({
      color: global_color,
      inline: true,
      container: true,
useAlpha: false,
format: "rgba"
    }). on('colorpickerChange colorpickerCreate', function (e) {
        
           $("h1,h2, #nav .fa-bars, #nav .closebtn, #nav .colored, #menu-step-back").css('color', e.color.toRgbString());
           $("header,  .settings_menu_button,#nav .colored").css('border-color', e.color.toRgbString());
           $(".settings_pagebox input:checked").css('background-color', e.color.toRgbString());

        $('#nav').addClass('full-nav'). promise().done(function(){ 
           $(".full-nav").css('border-color', e.color.toRgbString()) .promise().done(function(){ 
        $('#nav').removeClass('full-nav');
});
});
});
    $('#cp9_container').colorpicker({
      color: background_color,
      inline: true,
      container: true,

format: "rgba",
useAlpha: false,
		
    }). on('colorpickerChange colorpickerCreate', function (e) {
        $('#nav').addClass('full-nav'). promise().done(function(){ 
           $(".full-nav").css('background-color', e.color.toRgbString()) .promise().done(function(){ 
        $('#nav').removeClass('full-nav');
});
});

           $("html,body").css('background-color', e.color.toRgbString());
           $("#nav .not_colored").css('color', e.color.toRgbString());

});

});
$("#resetColors").click(function(){
  $('#cp9_container'). colorpicker('setValue',"#350E00");
  $('#cp8_container'). colorpicker('setValue',"#05FEFF");
});
$("#saveColors").click(function(){


var colorSet = 0;
var socket = io.connect("https://" + document.domain,{secure:true});
var lastReceived;
var nC = $('#cp8_container').data('colorpicker').color. toRgbString();
 socket.on('connect', function(data) {
if(!colorSet){
    socket.emit('updateCSSRequest', nC, $('#cp9_container').data('colorpicker').color. toRgbString());
$("#styleBox button").hide(1000);
$("#flexStyle").html("<div id='progressbar'></div> <div id='styleState'>Chargement...<br /> Cela peut prendre quelques minutes. </div>");
$( "#progressbar" ).progressbar({
      value: false
    });
$( "#progressbar" ).find( ".ui-progressbar-value" ).css("background-color",nC);
socket.on('disconnect',function(){alert('er');});
socket.on('updateCSSERROR',function(x){alert(x);});
	socket.on('updateCSS', function(ans,step) {
setInterval(function(){socket.emit('updateCSSRECONNECTION');},1000);
setTimeout(function(){alert("Quelque chose a disfonctionné");location.reload();},360000);

if(step == 6){
socket.emit('updateCSSConfirm');
setTimeout(function(){location.reload();},2000);

}

colorSet = 1;
});
}
});
});


</script>
<style> #cp9_container,#cp8_container{
text-align:center;
}
#styleBox{
text-align:center;
}
#flexStyle{
display:flex;
flex-wrap: wrap;
justify-content: space-around;
}
#saveColors{
margin-left:50%;
}
#resetColors,#saveColors{background: 0;
			border: 1px solid #D8D8D8;
text-align: center;
display: inline-block;
	color: #D8D8D8;
	padding: 1%;
	font-size: 90%;
border-radius: 15px;
cursor:pointer;
margin: 5% 5% ;}
.ui-progressbar {
    background-color: #ccc;
width:80%
margin:2% auto;
  }
  #progressbar .ui-progressbar-value,.ui-progressbar-indeterminate{
width:100%;
}
#styleState{
color:white;
margin-top:3%;
}
</style>
		<% 
var contentNames = Object.keys(content);
var contentL = contentNames.length;

		var loaded ={};
		for(var u = 0; u < contentL; u++){ 
var y = new RegExp(content[contentNames[u]].page,'g');
			if(y.test(page_name) && !loaded[content[contentNames[u]].script]){
loaded[content[contentNames[u]].script] == 1;%>
	<%- content[contentNames[u]].script %>
	<%	}}
	%>
</html>
